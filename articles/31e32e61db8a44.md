---
title: "S3ã‚¤ãƒ™ãƒ³ãƒˆã‚’EventBridgeã§å—ã‘ã¦ECSã‚¿ã‚¹ã‚¯ã§å‡¦ç†ã™ã‚‹(ç’°å¢ƒæ§‹ç¯‰)"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cdk","aws"]
published: false
---

# ã¯ã˜ã‚ã«

S3ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ãªã‚“ã‚‰ã‹ã®å‡¦ç†ã‚’è¡Œã„ãŸã„å ´åˆã«æœ€åˆã«è€ƒãˆã‚‹ã®ã¯Lambdaã§ã‚„ã‚‹æ–¹æ³•ã‹ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—ã€Lambdaã ã¨å®Ÿè¡Œæ™‚é–“15åˆ†ã®åˆ¶é™ãŒã‚ã‚Šã€æœ€åˆã¯ãã‚Œã§ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆãŸã‚‰å±ãªã„ã‹ãªï¼Ÿãªã‚“ã¦ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ãã‚“ãªæ™‚ã«ãµã¨ "s3 event ecs" ã¨æ¤œç´¢ã—ã¦ã¿ãŸã¨ã“ã‚Lambdaã‚’ã‹ã¾ã›ãšã«EventBridgeã§ãƒ«ãƒ¼ãƒ«è¨­å®šã™ã‚Œã°ã§ããã†ã ã¨ã‚ã‹ã‚Šã¾ã—ãŸã€‚

https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/events/CloudWatch-Events-tutorial-ECS.html

ãã‚Œãªã‚‰ã°å‰²ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã§å®Ÿç¾ã§ããã†ãªã®ã§è»½ã„æ°—æŒã¡ã§ã“ã‚Œã§ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã‚‰æ„å¤–ã¨æƒ…å ±ãŒå°‘ãªãã¦å¤§å¤‰ã ã£ãŸã®ã§ã“ã“ã«æ›¸ãæ®‹ã—ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨

ä»Šå›ã¯AWSç’°å¢ƒã®æ§‹ç¯‰ã«CDKã‚’åˆ©ç”¨ã—ã¾ã™ã€‚æ§‹ç¯‰ã™ã‚‹ç’°å¢ƒã¯ä»¥ä¸‹ã®æ§‹æˆã§ã™ã€‚
![images01](/images/articles/31e32e61db8a44/image01.drawio.png)

S3ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ãã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ECSã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•ã—ã¦ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãªã‚“ã‚‰ã‹ã®å‡¦ç†ã‚’ã—ãŸã„ã§ã™ã€‚

# S3

ã¾ãšã¯S3ã®ãƒã‚±ãƒƒãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

```typescript
export class S3Stack extends cdk.Stack {
    // Create Bucket
    public bulkFilesBucket : s3.Bucket
    constructor(scope: Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);

        this.bulkFilesBucket = new s3.Bucket(this, "TestBucket", {
            bucketName: "test-bucket",
            blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
            eventBridgeEnabled: true,
        });
    };
}
```

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ `eventBridgeEnabled` ã§ã™ã€‚
trueã«ã™ã‚‹ã¨EventBridgeã«å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãŒé£›ã¶ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# ECS

## VPC

ECSã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•ã™ã‚‹VPCã‚’ç”¨æ„ã—ã¾ã™ã€‚
ã‚µãƒ–ãƒãƒƒãƒˆã®ã¨ã“ã‚ã¯ä¸€èˆ¬çš„ã«ã‚ˆãã‚ã‚Šãã†ãªæ§‹æˆã§æ›¸ã„ã¦ã¿ã¾ã—ãŸãŒå¿…è¦ãªç’°å¢ƒã«åˆã‚ã›ã¦å¤‰ãˆã¦ãã ã•ã„ã€‚

```typescript
export class Vpcs {
    public vpc: Vpc
    constructor(scope: Construct, id: string) {
      this.vpc = new Vpc(scope, id, {
        ipAddresses: IpAddresses.cidr('10.0.0.0/16'),
        defaultInstanceTenancy: DefaultInstanceTenancy.DEFAULT,
        enableDnsSupport: true,
        enableDnsHostnames: true,
        subnetConfiguration: [
          {
            cidrMask: 24,
            name: "public",
            subnetType: ec2.SubnetType.PUBLIC,
          },
          {
            cidrMask: 24,
            name: "App",
            subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS,
          },
          {
            cidrMask: 28,
            name: "RDS",
            subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
          },
        ],
        natGateways: 1,
        // maxAzs: 2,
      });
      this.vpc.applyRemovalPolicy(cdk.RemovalPolicy.DESTROY)
    }
}
  
```

## SecurityGroup

ECSã‚¿ã‚¹ã‚¯ç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```typescript
interface SecurityGroupProps extends StackProps {
    vpc: Vpc;
}

export class SecurityGroups {
    public ecsSecurityGroup: SecurityGroup;

    constructor(scope: Construct, id: string, props: SecurityGroupProps){
        this.ecsSecurityGroup = new SecurityGroup(scope, 'EcsSg', {
            vpc: props.vpc,
        })
    }
}
```
## ECS & EventBridge

æ¬¡ã«ECSã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
ä»Šå›ã¯EventBridgeã®ãƒ«ãƒ¼ãƒ«ã‚‚EcsStackå†…ã«ä¸€ç·’ã«å®šç¾©ã—ã¾ã™ã€‚

```typescript
export class EcsStack extends cdk.Stack {

        constructor(scope: Construct, id: string, props?: cdk.StackProps) {
            super(scope, id, props)

        // VPC
        const vpc = new Vpcs(this, id + 'Vpc').vpc
        // SecurityGroup
        const sg = new SecurityGroups(this, id, {
            vpc: vpc
        });
        // ECS Cluseter
        const cluster = new Cluster(this, id + 'Cluster', {
            clusterName: 'EventHandlerCluster',
            vpc: vpc,
        });
        // EventBridgeã‹ã‚‰èµ·å‹•ã™ã‚‹ã‚¿ã‚¹ã‚¯å®šç¾©
        const s3EventHandleTask = new FargateTaskDefinition(this, 's3EventHandleTask', {
            memoryLimitMiB: 512,
        });
        s3EventHandleTask.addContainer('handlerTaskContainer', {
            containerName: "s3EventHandleTaskContainer",
            image: ContainerImage.fromAsset('../../', {
                platform: Platform.LINUX_AMD64,
            }),
            command:[
                "/app",
            ],
            logging: LogDrivers.awsLogs({streamPrefix: 's3EventHandleTask'})
        });
        s3EventHandleTask.addToTaskRolePolicy(
            new PolicyStatement({
                actions: [
                    's3:*',
                ],
                resources: ["*"]
            })
        )
        // EventBrigeã®ãƒ«ãƒ¼ãƒ«å®šç¾©ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è¨­å®š
        const rule = new Rule(this, 's3EventRule', {
            ruleName: 's3EventRule',
            enabled: true,
            eventPattern: {
                "source": ["aws.s3"],
                "detailType": ["Object Created"],
                "detail": {
                        "bucket": {
                        "name": ["test-bucket"]
                    }
                }
            },
            targets: [new EcsTask({
                cluster: cluster,
                taskDefinition: s3EventHandleTask,
                taskCount: 1,
                securityGroups: [sg.ecsSecurityGroup],
                containerOverrides: [{
                    containerName: "s3EventHandleTaskContainer",
                    environment: [
                        {
                            name: "bucketName",
                            value: EventField.fromPath("$.detail.bucket.name")
                        },
                        {
                            name: "objectKey",
                            value: EventField.fromPath("$.detail.object.key")
                        },
                    ]
                }],
            })]
        });
    }
}
```

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ `containerOverrides` ã®éƒ¨åˆ†ã§ã™ã€‚
ã“ã“ã® `environment` ã®è¨˜è¿°ã‚’ã™ã‚‹ã“ã¨ã§EventBrigeãŒå—ä¿¡ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®å¿…è¦ãªç®‡æ‰€ã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã®ã‚„ã‚Šæ–¹ãŒã‚ã¾ã‚Šã‚µãƒ³ãƒ—ãƒ«ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªãã¦è©¦è¡ŒéŒ¯èª¤ã—ã¾ã—ãŸã€‚

`EventField.fromPath` ã®ãƒ‘ã‚¹ã®æŒ‡å®šã¯S3ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®Jsonã‚’æƒ³å®šã—ã¦è¨˜è¼‰ã—ã¾ã™ã€‚
ä¸Šè¨˜ã®ä¾‹ã§ã¯bucket name ã¨ object keyã—ã‹è¨­å®šã—ã¦ã„ã¾ã›ã‚“ãŒã‚¤ãƒ™ãƒ³ãƒˆå†…ã®ä»–ã®é …ç›®å–å¾—ã§ãã¾ã™ã€‚

```json
{
  "version": "0",
  "id": "436cee3f-1218-b9b1-293d-cc0506eeba5f",
  "detail-type": "Object Created",
  "source": "aws.s3",
  "account": "XXXXXXXXXXXX",
  "time": "2021-11-30T03:56:14Z",
  "region": "us-east-1",
  "resources": ["arn:aws:s3:::test-bucket"],
  "detail": {
    "version": "0",
    "bucket": { "name": "test-bucket" },
    "object": {
      "key": "test.png",
      "size": 93617,
      "etag": "035bf1fc4b0a420b23c170769f6b7dfe",
      "sequencer": "0061A5A0DE6C9F3646"
    },
    "request-id": "DMGFBG77TRA4ZWAJ",
    "requester": "XXXXXXXXXXXX",
    "source-ip-address": "14.12.5.225",
    "reason": "PutObject"
  }
}
```

# çµ‚ã‚ã‚Šã«

ã„ãã‚‰ã‹æƒ…å ±ãŒå°‘ãªã„ã¨ã“ã‚ãŒã‚ã‚Šã“ã‚“ãªã“ã¨ã§ãã‚‹ã®ã‹ãªï¼Ÿãã‚Œã¯ã©ã†ã‚„ã£ã¦æ›¸ãã®ã‹ãªï¼Ÿã¨è©¦è¡ŒéŒ¯èª¤ã—ãŸã¨ã“ã‚ãŒã‚ã‚Šã¾ã—ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚
ã“ã‚Œã‹ã‚‰åŒã˜ã‚ˆã†ãªã“ã¨ã‚’ã™ã‚‹æ–¹ã«å°‘ã—ã§ã‚‚å‚è€ƒã«ãªã£ãŸã‚‰å¬‰ã—ã„ã§ã™ã€‚

å…¨ã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ãã¾ã—ãŸã®ã§ã“ã¡ã‚‰ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚

Coming soon.
