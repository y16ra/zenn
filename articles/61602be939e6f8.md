---
title: "Snowflake MCPサーバ入門：Cortex Search Serviceでドキュメント検索を実装する"
emoji: "❄️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Snowflake", "MCP", "Cortex", "AI"]
published: true
published_at: 2025-12-21
---

## はじめに

Snowflakeでは、Model Context Protocol（MCP）サーバを作成することで、SnowflakeのCortex機能を外部のAIアプリケーションから利用できるようになります。本記事では、SnowflakeでMCPサーバを作成し、Snowflakeドキュメント検索サービスを提供するMCPサーバの構築手順を紹介します。

## MCPとは

Model Context Protocol（MCP）は、AIアプリケーションとデータソースやツールを接続するためのオープンプロトコルです。
SnowflakeではMCPサーバを**Snowflakeが管理するマネージドサービス**として簡単に作成することができます。
この機能を利用することでMCPサーバの運用やメンテナンスの負担が軽減され、セキュアで標準準拠のインターフェースを提供します。また、SnowflakeのOAuthサービスを使用した認証や、ロールベースアクセス制御（RBAC）による権限管理も利用できます。

## SnowflakeのMCPサーバでできること

SnowflakeのMCPサーバでは、以下の5種類のツールタイプを利用できます。これらのツールを組み合わせることで、様々なAIアプリケーションからSnowflakeの機能を活用できます。

### 利用可能なツールタイプ

#### 1. CORTEX_SEARCH_SERVICE_QUERY
Cortex Search Serviceを使用した検索機能を提供します。大量のドキュメントやデータからセマンティック検索を実行し、関連性の高い情報を取得できます。

```sql
- name: "product-search"
  type: "CORTEX_SEARCH_SERVICE_QUERY"
  identifier: "database.schema.cortex_search_service"
  description: "製品検索サービス"
  title: "Product Search"
```

#### 2. CORTEX_ANALYST_MESSAGE
Cortex Analystを使用して、セマンティックビューに対して自然言語で質問できます。SQLの知識がなくても、ビジネスユーザーがデータを分析できます。

```sql
- name: "revenue-semantic-view"
  type: "CORTEX_ANALYST_MESSAGE"
  identifier: "database.schema.semantic_view"
  description: "収益データのセマンティックビュー"
  title: "Semantic view for revenue"
```

#### 3. SYSTEM_EXECUTE_SQL
Snowflakeデータベースに対して任意のSQLクエリを実行できます。AIエージェントが動的にSQLを生成して実行し、データを取得・分析できます。

```sql
- name: "sql_exec_tool"
  type: "SYSTEM_EXECUTE_SQL"
  description: "Snowflakeデータベースに対してSQLクエリを実行するツール"
  title: "SQL Execution Tool"
```

#### 4. CORTEX_AGENT_RUN
事前に定義されたCortex Agentを実行できます。複雑なタスクを自動化し、エージェントに処理を委任できます。

```sql
- name: "customer_agent"
  type: "CORTEX_AGENT_RUN"
  identifier: "database.schema.customer_service_agent"
  description: "カスタマーサービス対応用のエージェント"
  title: "Customer Service Agent"
```

#### 5. CUSTOM
カスタムのUDF（User-Defined Function）やストアドプロシージャをツールとして公開できます。独自のビジネスロジックをAIアプリケーションから呼び出せます。

```sql
- name: "multiply_by_ten"
  type: "CUSTOM"
  identifier: "database.schema.multiply_by_ten"
  description: "入力値を10倍にして返す"
  title: "Multiply by Ten"
  config:
    type: "function"  # または "procedure"
    warehouse: "compute_warehouse"
    input_schema:
      type: "object"
      properties:
        x:
          type: "number"
          description: "10倍にする数値"
```

### 主な特徴

- **標準準拠のインターフェース**: MCPプロトコルに準拠しているため、様々なAIアプリケーション（Claude、ChatGPT、Cursorなど）と統合可能
- **セキュアな認証**: SnowflakeのOAuthサービスを使用した認証により、安全に接続
- **細かい権限管理**: ロールベースアクセス制御（RBAC）により、ツールごとに適切な権限を設定可能
- **マネージドサービス**: インフラの管理が不要で、運用負担が軽減

## MCPサーバの構築手順

それでは、実際にSnowflakeでMCPサーバを作成する手順を説明します。本記事では、Snowflakeドキュメント検索サービスを提供するMCPサーバを例として構築します。

### 前提条件

MCPサーバを作成する前に、以下の前提条件を満たしている必要があります。

- Snowflakeアカウントへのアクセス権限
- 以下のデータベースとスキーマへのアクセス権限：
  - `SNOWFLAKE_DOCUMENTATION`（Snowflake Marketplaceから取得したインポートされたデータベース）
- 管理者権限またはMCPサーバ作成権限

### 1. データベースの選択

まず、MCPサーバを作成するデータベースを選択します。

```sql
USE DATABASE mcp_database;
```

### 2. MCPサーバの作成

`CREATE MCP SERVER`コマンドを使用してMCPサーバを作成します。この例では、Snowflakeドキュメント検索用のMCPサーバを作成します。

```sql
CREATE OR REPLACE MCP SERVER snowflake_docs_mcp_server
  FROM SPECIFICATION $$
    tools:
      - name: "snowflake-docs-search"
        type: "CORTEX_SEARCH_SERVICE_QUERY"
        identifier: "SNOWFLAKE_DOCUMENTATION.SHARED.CKE_SNOWFLAKE_DOCS_SERVICE"
        description: "Snowflakeドキュメント検索サービス"
        title: "Snowflake Docs Search"
  $$;
```

このMCPサーバには、以下のツールが定義されています：

1. **snowflake-docs-search**: Cortex Search Serviceを使用したドキュメント検索ツール

### 3. MCPサーバの確認

作成したMCPサーバを確認します。

```sql
-- アカウント内のMCPサーバ一覧を表示
SHOW MCP SERVERS IN ACCOUNT;

-- MCPサーバの詳細を表示
DESCRIBE MCP SERVER snowflake_docs_mcp_server;
```

### 4. 権限設定

MCPサーバを使用するには、適切な権限を設定する必要があります。

### 1. ロールの作成

MCPサーバを使用するための専用ロールを作成します。

```sql
CREATE ROLE IF NOT EXISTS SNOWFLAKE_DOCS_MCP_USER;
```

### 2. データベースへの権限付与

必要なデータベースとスキーマへの権限を付与します。

```sql
-- Snowflake Marketplaceから取得したインポートされたデータベースへの権限
GRANT IMPORTED PRIVILEGES ON DATABASE SNOWFLAKE_DOCUMENTATION TO ROLE SNOWFLAKE_DOCS_MCP_USER;

-- MCPサーバが配置されているデータベースへの権限
GRANT USAGE ON DATABASE mcp_database TO ROLE SNOWFLAKE_DOCS_MCP_USER;
GRANT USAGE ON SCHEMA mcp_database.public TO ROLE SNOWFLAKE_DOCS_MCP_USER;
```

### 3. MCPサーバへの権限付与

MCPサーバ自体への使用権限を付与します。

```sql
GRANT USAGE ON MCP SERVER mcp_database.public.snowflake_docs_mcp_server TO ROLE SNOWFLAKE_DOCS_MCP_USER;
```

### 4. ユーザーへのロール付与

作成したロールをユーザーに付与します。

```sql
GRANT ROLE SNOWFLAKE_DOCS_MCP_USER TO USER example_user;
```

### 5. 権限の確認

権限が正しく設定されているか確認します。

```sql
SHOW GRANTS ON MCP SERVER mcp_database.public.snowflake_docs_mcp_server;
```

### 6. 接続確認

MCPサーバが正しく動作しているか、REST APIを使用して確認します。

```bash
curl -X POST \
  "https://<ACCOUNT_IDENTIFIER>.snowflakecomputing.com/api/v2/databases/<DATABASE_NAME>/schemas/<SCHEMA_NAME>/mcp-servers/snowflake_docs_mcp_server" \
  --header 'Content-Type: application/json' \
  --header 'Accept: application/json' \
  --header "Authorization: Bearer <YOUR-PAT-TOKEN>" \
  --data '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
  }'
```

**注意**: 上記のコマンドでは、以下の値を実際の値に置き換えてください：
- `<ACCOUNT_IDENTIFIER>`: Snowflakeアカウント識別子
- `<DATABASE_NAME>`: MCPサーバが配置されているデータベース名
- `<SCHEMA_NAME>`: MCPサーバが配置されているスキーマ名
- `<YOUR-PAT-TOKEN>`: Personal Access Token（PAT）

正常に動作している場合、以下のようなレスポンスが返されます：

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "tools": [
      {
        "name": "snowflake-docs-search",
        "description": "Snowflakeドキュメント検索サービス",
        "title": "Snowflake Docs Search"
      }
    ]
  }
}
```

## まとめ

本記事では、SnowflakeでMCPサーバを作成する手順を紹介しました。MCPサーバを作成することで、SnowflakeのCortex機能を外部のAIアプリケーションから利用できるようになります。

主な手順は以下の通りです：

1. MCPサーバの作成（`CREATE MCP SERVER`）
2. 必要な権限の設定
3. 接続確認

MCPサーバを活用することで、Snowflakeの強力な検索機能やエージェント機能を、様々なAIアプリケーションから利用できるようになります。ぜひ試してみてください。

## 参考資料

- [Snowflake-managed MCP server | Snowflake Documentation](https://docs.snowflake.com/en/user-guide/snowflake-cortex/cortex-agents-mcp)
- [Snowflake Documentation - MCP Servers](https://docs.snowflake.com/)
- [Model Context Protocol (MCP) Specification](https://modelcontextprotocol.io/)
